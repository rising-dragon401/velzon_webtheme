import{getDocument}from"ssr-window";import{now}from"../../shared/utils.js";export default function onTouchMove(e){const t=getDocument(),r=this,a=r.touchEventsData,{params:s,touches:n,rtlTranslate:o,enabled:i}=r;if(!i)return;if(!s.simulateTouch&&"mouse"===e.pointerType)return;let l=e;if(l.originalEvent&&(l=l.originalEvent),!a.isTouched)return void(a.startMoving&&a.isScrolling&&r.emit("touchMoveOpposite",l));const c=a.evCache.findIndex((e=>e.pointerId===l.pointerId));c>=0&&(a.evCache[c]=l);const u=a.evCache.length>1?a.evCache[0]:l,d=u.pageX,h=u.pageY;if(l.preventedByNestedSwiper)return n.startX=d,void(n.startY=h);if(!r.allowTouchMove)return l.target.matches(a.focusableElements)||(r.allowClick=!1),void(a.isTouched&&(Object.assign(n,{startX:d,startY:h,prevX:r.touches.currentX,prevY:r.touches.currentY,currentX:d,currentY:h}),a.touchStartTime=now()));if(s.touchReleaseOnEdges&&!s.loop)if(r.isVertical()){if(h<n.startY&&r.translate<=r.maxTranslate()||h>n.startY&&r.translate>=r.minTranslate())return a.isTouched=!1,void(a.isMoved=!1)}else if(d<n.startX&&r.translate<=r.maxTranslate()||d>n.startX&&r.translate>=r.minTranslate())return;if(t.activeElement&&l.target===t.activeElement&&l.target.matches(a.focusableElements))return a.isMoved=!0,void(r.allowClick=!1);if(a.allowTouchCallbacks&&r.emit("touchMove",l),l.targetTouches&&l.targetTouches.length>1)return;n.currentX=d,n.currentY=h;const T=n.currentX-n.startX,v=n.currentY-n.startY;if(r.params.threshold&&Math.sqrt(T**2+v**2)<r.params.threshold)return;if(void 0===a.isScrolling){let e;r.isHorizontal()&&n.currentY===n.startY||r.isVertical()&&n.currentX===n.startX?a.isScrolling=!1:T*T+v*v>=25&&(e=180*Math.atan2(Math.abs(v),Math.abs(T))/Math.PI,a.isScrolling=r.isHorizontal()?e>s.touchAngle:90-e>s.touchAngle)}if(a.isScrolling&&r.emit("touchMoveOpposite",l),void 0===a.startMoving&&(n.currentX===n.startX&&n.currentY===n.startY||(a.startMoving=!0)),a.isScrolling||r.zoom&&r.params.zoom&&r.params.zoom.enabled&&a.evCache.length>1)return void(a.isTouched=!1);if(!a.startMoving)return;r.allowClick=!1,!s.cssMode&&l.cancelable&&l.preventDefault(),s.touchMoveStopPropagation&&!s.nested&&l.stopPropagation();let p=r.isHorizontal()?T:v,m=r.isHorizontal()?n.currentX-n.previousX:n.currentY-n.previousY;s.oneWayMovement&&(p=Math.abs(p)*(o?1:-1),m=Math.abs(m)*(o?1:-1)),n.diff=p,p*=s.touchRatio,o&&(p=-p,m=-m);const M=r.touchesDirection;r.swipeDirection=p>0?"prev":"next",r.touchesDirection=m>0?"prev":"next";const f=r.params.loop&&!s.cssMode;if(!a.isMoved){if(f&&r.loopFix({direction:r.swipeDirection}),a.startTranslate=r.getTranslate(),r.setTransition(0),r.animating){const e=new window.CustomEvent("transitionend",{bubbles:!0,cancelable:!0});r.wrapperEl.dispatchEvent(e)}a.allowMomentumBounce=!1,!s.grabCursor||!0!==r.allowSlideNext&&!0!==r.allowSlidePrev||r.setGrabCursor(!0),r.emit("sliderFirstMove",l)}let g;a.isMoved&&M!==r.touchesDirection&&f&&Math.abs(p)>=1&&(r.loopFix({direction:r.swipeDirection,setTranslate:!0}),g=!0),r.emit("sliderMove",l),a.isMoved=!0,a.currentTranslate=p+a.startTranslate;let w=!0,x=s.resistanceRatio;if(s.touchReleaseOnEdges&&(x=0),p>0?(f&&!g&&a.currentTranslate>(s.centeredSlides?r.minTranslate()-r.size/2:r.minTranslate())&&r.loopFix({direction:"prev",setTranslate:!0,activeSlideIndex:0}),a.currentTranslate>r.minTranslate()&&(w=!1,s.resistance&&(a.currentTranslate=r.minTranslate()-1+(-r.minTranslate()+a.startTranslate+p)**x))):p<0&&(f&&!g&&a.currentTranslate<(s.centeredSlides?r.maxTranslate()+r.size/2:r.maxTranslate())&&r.loopFix({direction:"next",setTranslate:!0,activeSlideIndex:r.slides.length-("auto"===s.slidesPerView?r.slidesPerViewDynamic():Math.ceil(parseFloat(s.slidesPerView,10)))}),a.currentTranslate<r.maxTranslate()&&(w=!1,s.resistance&&(a.currentTranslate=r.maxTranslate()+1-(r.maxTranslate()-a.startTranslate-p)**x))),w&&(l.preventedByNestedSwiper=!0),!r.allowSlideNext&&"next"===r.swipeDirection&&a.currentTranslate<a.startTranslate&&(a.currentTranslate=a.startTranslate),!r.allowSlidePrev&&"prev"===r.swipeDirection&&a.currentTranslate>a.startTranslate&&(a.currentTranslate=a.startTranslate),r.allowSlidePrev||r.allowSlideNext||(a.currentTranslate=a.startTranslate),s.threshold>0){if(!(Math.abs(p)>s.threshold||a.allowThresholdMove))return void(a.currentTranslate=a.startTranslate);if(!a.allowThresholdMove)return a.allowThresholdMove=!0,n.startX=n.currentX,n.startY=n.currentY,a.currentTranslate=a.startTranslate,void(n.diff=r.isHorizontal()?n.currentX-n.startX:n.currentY-n.startY)}s.followFinger&&!s.cssMode&&((s.freeMode&&s.freeMode.enabled&&r.freeMode||s.watchSlidesProgress)&&(r.updateActiveIndex(),r.updateSlidesClasses()),r.params.freeMode&&s.freeMode.enabled&&r.freeMode&&r.freeMode.onTouchMove(),r.updateProgress(a.currentTranslate),r.setTranslate(a.currentTranslate))}
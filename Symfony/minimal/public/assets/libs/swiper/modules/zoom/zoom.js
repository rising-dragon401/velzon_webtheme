import{getWindow}from"ssr-window";import{elementChildren,elementOffset,elementParents,getTranslate}from"../../shared/utils.js";export default function Zoom({swiper:e,extendParams:t,on:i,emit:a}){const r=getWindow();t({zoom:{enabled:!1,maxRatio:3,minRatio:1,toggle:!0,containerClass:"swiper-zoom-container",zoomedSlideClass:"swiper-slide-zoomed"}}),e.zoom={enabled:!1};let s,o,n=1,l=!1;const m=[],c={originX:0,originY:0,slideEl:void 0,slideWidth:void 0,slideHeight:void 0,imageEl:void 0,imageWrapEl:void 0,maxRatio:3},d={isTouched:void 0,isMoved:void 0,currentX:void 0,currentY:void 0,minX:void 0,minY:void 0,maxX:void 0,maxY:void 0,width:void 0,height:void 0,startX:void 0,startY:void 0,touchesStart:{},touchesCurrent:{}},u={x:void 0,y:void 0,prevPositionX:void 0,prevPositionY:void 0,prevTime:void 0};let p=1;function g(){if(m.length<2)return 1;const e=m[0].pageX,t=m[0].pageY,i=m[1].pageX,a=m[1].pageY;return Math.sqrt((i-e)**2+(a-t)**2)}function h(t){const i=e.isElement?"swiper-slide":`.${e.params.slideClass}`;return!!t.target.matches(i)||e.slides.filter((e=>e.contains(t.target))).length>0}function E(t){if("mouse"===t.pointerType&&m.splice(0,m.length),!h(t))return;const i=e.params.zoom;if(s=!1,o=!1,m.push(t),!(m.length<2)){if(s=!0,c.scaleStart=g(),!c.slideEl){c.slideEl=t.target.closest(`.${e.params.slideClass}, swiper-slide`),c.slideEl||(c.slideEl=e.slides[e.activeIndex]);let a=c.slideEl.querySelector(`.${i.containerClass}`);if(a&&(a=a.querySelectorAll("picture, img, svg, canvas, .swiper-zoom-target")[0]),c.imageEl=a,c.imageWrapEl=a?elementParents(c.imageEl,`.${i.containerClass}`)[0]:void 0,!c.imageWrapEl)return void(c.imageEl=void 0);c.maxRatio=c.imageWrapEl.getAttribute("data-swiper-zoom")||i.maxRatio}if(c.imageEl){const[e,t]=function(){if(m.length<2)return{x:null,y:null};const e=c.imageEl.getBoundingClientRect();return[(m[0].pageX+(m[1].pageX-m[0].pageX)/2-e.x)/n,(m[0].pageY+(m[1].pageY-m[0].pageY)/2-e.y)/n]}();c.originX=e,c.originY=t,c.imageEl.style.transitionDuration="0ms"}l=!0}}function v(t){if(!h(t))return;const i=e.params.zoom,a=e.zoom,r=m.findIndex((e=>e.pointerId===t.pointerId));r>=0&&(m[r]=t),m.length<2||(o=!0,c.scaleMove=g(),c.imageEl&&(a.scale=c.scaleMove/c.scaleStart*n,a.scale>c.maxRatio&&(a.scale=c.maxRatio-1+(a.scale-c.maxRatio+1)**.5),a.scale<i.minRatio&&(a.scale=i.minRatio+1-(i.minRatio-a.scale+1)**.5),c.imageEl.style.transform=`translate3d(0,0,0) scale(${a.scale})`))}function f(t){if(!h(t))return;if("mouse"===t.pointerType&&"pointerout"===t.type)return;const i=e.params.zoom,a=e.zoom,r=m.findIndex((e=>e.pointerId===t.pointerId));r>=0&&m.splice(r,1),s&&o&&(s=!1,o=!1,c.imageEl&&(a.scale=Math.max(Math.min(a.scale,c.maxRatio),i.minRatio),c.imageEl.style.transitionDuration=`${e.params.speed}ms`,c.imageEl.style.transform=`translate3d(0,0,0) scale(${a.scale})`,n=a.scale,l=!1,a.scale>1&&c.slideEl?c.slideEl.classList.add(`${i.zoomedSlideClass}`):a.scale<=1&&c.slideEl&&c.slideEl.classList.remove(`${i.zoomedSlideClass}`),1===a.scale&&(c.originX=0,c.originY=0,c.slideEl=void 0)))}function x(t){if(!h(t)||!function(t){const i=`.${e.params.zoom.containerClass}`;return!!t.target.matches(i)||[...e.el.querySelectorAll(i)].filter((e=>e.contains(t.target))).length>0}(t))return;const i=e.zoom;if(!c.imageEl)return;if(!d.isTouched||!c.slideEl)return;d.isMoved||(d.width=c.imageEl.offsetWidth,d.height=c.imageEl.offsetHeight,d.startX=getTranslate(c.imageWrapEl,"x")||0,d.startY=getTranslate(c.imageWrapEl,"y")||0,c.slideWidth=c.slideEl.offsetWidth,c.slideHeight=c.slideEl.offsetHeight,c.imageWrapEl.style.transitionDuration="0ms");const a=d.width*i.scale,r=d.height*i.scale;if(a<c.slideWidth&&r<c.slideHeight)return;d.minX=Math.min(c.slideWidth/2-a/2,0),d.maxX=-d.minX,d.minY=Math.min(c.slideHeight/2-r/2,0),d.maxY=-d.minY,d.touchesCurrent.x=m.length>0?m[0].pageX:t.pageX,d.touchesCurrent.y=m.length>0?m[0].pageY:t.pageY;if(Math.max(Math.abs(d.touchesCurrent.x-d.touchesStart.x),Math.abs(d.touchesCurrent.y-d.touchesStart.y))>5&&(e.allowClick=!1),!d.isMoved&&!l){if(e.isHorizontal()&&(Math.floor(d.minX)===Math.floor(d.startX)&&d.touchesCurrent.x<d.touchesStart.x||Math.floor(d.maxX)===Math.floor(d.startX)&&d.touchesCurrent.x>d.touchesStart.x))return void(d.isTouched=!1);if(!e.isHorizontal()&&(Math.floor(d.minY)===Math.floor(d.startY)&&d.touchesCurrent.y<d.touchesStart.y||Math.floor(d.maxY)===Math.floor(d.startY)&&d.touchesCurrent.y>d.touchesStart.y))return void(d.isTouched=!1)}t.cancelable&&t.preventDefault(),t.stopPropagation(),d.isMoved=!0;const s=(i.scale-n)/(c.maxRatio-e.params.zoom.minRatio),{originX:o,originY:p}=c;d.currentX=d.touchesCurrent.x-d.touchesStart.x+d.startX+s*(d.width-2*o),d.currentY=d.touchesCurrent.y-d.touchesStart.y+d.startY+s*(d.height-2*p),d.currentX<d.minX&&(d.currentX=d.minX+1-(d.minX-d.currentX+1)**.8),d.currentX>d.maxX&&(d.currentX=d.maxX-1+(d.currentX-d.maxX+1)**.8),d.currentY<d.minY&&(d.currentY=d.minY+1-(d.minY-d.currentY+1)**.8),d.currentY>d.maxY&&(d.currentY=d.maxY-1+(d.currentY-d.maxY+1)**.8),u.prevPositionX||(u.prevPositionX=d.touchesCurrent.x),u.prevPositionY||(u.prevPositionY=d.touchesCurrent.y),u.prevTime||(u.prevTime=Date.now()),u.x=(d.touchesCurrent.x-u.prevPositionX)/(Date.now()-u.prevTime)/2,u.y=(d.touchesCurrent.y-u.prevPositionY)/(Date.now()-u.prevTime)/2,Math.abs(d.touchesCurrent.x-u.prevPositionX)<2&&(u.x=0),Math.abs(d.touchesCurrent.y-u.prevPositionY)<2&&(u.y=0),u.prevPositionX=d.touchesCurrent.x,u.prevPositionY=d.touchesCurrent.y,u.prevTime=Date.now(),c.imageWrapEl.style.transform=`translate3d(${d.currentX}px, ${d.currentY}px,0)`}function X(){const t=e.zoom;c.slideEl&&e.activeIndex!==e.slides.indexOf(c.slideEl)&&(c.imageEl&&(c.imageEl.style.transform="translate3d(0,0,0) scale(1)"),c.imageWrapEl&&(c.imageWrapEl.style.transform="translate3d(0,0,0)"),c.slideEl.classList.remove(`${e.params.zoom.zoomedSlideClass}`),t.scale=1,n=1,c.slideEl=void 0,c.imageEl=void 0,c.imageWrapEl=void 0,c.originX=0,c.originY=0)}function Y(t){const i=e.zoom,a=e.params.zoom;if(!c.slideEl){t&&t.target&&(c.slideEl=t.target.closest(`.${e.params.slideClass}, swiper-slide`)),c.slideEl||(e.params.virtual&&e.params.virtual.enabled&&e.virtual?c.slideEl=elementChildren(e.slidesEl,`.${e.params.slideActiveClass}`)[0]:c.slideEl=e.slides[e.activeIndex]);let i=c.slideEl.querySelector(`.${a.containerClass}`);i&&(i=i.querySelectorAll("picture, img, svg, canvas, .swiper-zoom-target")[0]),c.imageEl=i,c.imageWrapEl=i?elementParents(c.imageEl,`.${a.containerClass}`)[0]:void 0}if(!c.imageEl||!c.imageWrapEl)return;let s,o,l,m,u,p,g,h,E,v,f,x,X,Y,y,z,C,w;e.params.cssMode&&(e.wrapperEl.style.overflow="hidden",e.wrapperEl.style.touchAction="none"),c.slideEl.classList.add(`${a.zoomedSlideClass}`),void 0===d.touchesStart.x&&t?(s=t.pageX,o=t.pageY):(s=d.touchesStart.x,o=d.touchesStart.y);const M="number"==typeof t?t:null;1===n&&M&&(s=void 0,o=void 0),i.scale=M||c.imageWrapEl.getAttribute("data-swiper-zoom")||a.maxRatio,n=M||c.imageWrapEl.getAttribute("data-swiper-zoom")||a.maxRatio,!t||1===n&&M?(g=0,h=0):(C=c.slideEl.offsetWidth,w=c.slideEl.offsetHeight,l=elementOffset(c.slideEl).left+r.scrollX,m=elementOffset(c.slideEl).top+r.scrollY,u=l+C/2-s,p=m+w/2-o,E=c.imageEl.offsetWidth,v=c.imageEl.offsetHeight,f=E*i.scale,x=v*i.scale,X=Math.min(C/2-f/2,0),Y=Math.min(w/2-x/2,0),y=-X,z=-Y,g=u*i.scale,h=p*i.scale,g<X&&(g=X),g>y&&(g=y),h<Y&&(h=Y),h>z&&(h=z)),M&&1===i.scale&&(c.originX=0,c.originY=0),c.imageWrapEl.style.transitionDuration="300ms",c.imageWrapEl.style.transform=`translate3d(${g}px, ${h}px,0)`,c.imageEl.style.transitionDuration="300ms",c.imageEl.style.transform=`translate3d(0,0,0) scale(${i.scale})`}function y(){const t=e.zoom,i=e.params.zoom;if(!c.slideEl){e.params.virtual&&e.params.virtual.enabled&&e.virtual?c.slideEl=elementChildren(e.slidesEl,`.${e.params.slideActiveClass}`)[0]:c.slideEl=e.slides[e.activeIndex];let t=c.slideEl.querySelector(`.${i.containerClass}`);t&&(t=t.querySelectorAll("picture, img, svg, canvas, .swiper-zoom-target")[0]),c.imageEl=t,c.imageWrapEl=t?elementParents(c.imageEl,`.${i.containerClass}`)[0]:void 0}c.imageEl&&c.imageWrapEl&&(e.params.cssMode&&(e.wrapperEl.style.overflow="",e.wrapperEl.style.touchAction=""),t.scale=1,n=1,c.imageWrapEl.style.transitionDuration="300ms",c.imageWrapEl.style.transform="translate3d(0,0,0)",c.imageEl.style.transitionDuration="300ms",c.imageEl.style.transform="translate3d(0,0,0) scale(1)",c.slideEl.classList.remove(`${i.zoomedSlideClass}`),c.slideEl=void 0,c.originX=0,c.originY=0)}function z(t){const i=e.zoom;i.scale&&1!==i.scale?y():Y(t)}function C(){return{passiveListener:!!e.params.passiveListeners&&{passive:!0,capture:!1},activeListenerWithCapture:!e.params.passiveListeners||{passive:!1,capture:!0}}}function w(){const t=e.zoom;if(t.enabled)return;t.enabled=!0;const{passiveListener:i,activeListenerWithCapture:a}=C();e.wrapperEl.addEventListener("pointerdown",E,i),e.wrapperEl.addEventListener("pointermove",v,a),["pointerup","pointercancel","pointerout"].forEach((t=>{e.wrapperEl.addEventListener(t,f,i)})),e.wrapperEl.addEventListener("pointermove",x,a)}function M(){const t=e.zoom;if(!t.enabled)return;t.enabled=!1;const{passiveListener:i,activeListenerWithCapture:a}=C();e.wrapperEl.removeEventListener("pointerdown",E,i),e.wrapperEl.removeEventListener("pointermove",v,a),["pointerup","pointercancel","pointerout"].forEach((t=>{e.wrapperEl.removeEventListener(t,f,i)})),e.wrapperEl.removeEventListener("pointermove",x,a)}Object.defineProperty(e.zoom,"scale",{get:()=>p,set(e){if(p!==e){const t=c.imageEl,i=c.slideEl;a("zoomChange",e,t,i)}p=e}}),i("init",(()=>{e.params.zoom.enabled&&w()})),i("destroy",(()=>{M()})),i("touchStart",((t,i)=>{e.zoom.enabled&&function(t){const i=e.device;if(!c.imageEl)return;if(d.isTouched)return;i.android&&t.cancelable&&t.preventDefault(),d.isTouched=!0;const a=m.length>0?m[0]:t;d.touchesStart.x=a.pageX,d.touchesStart.y=a.pageY}(i)})),i("touchEnd",((t,i)=>{e.zoom.enabled&&function(){const t=e.zoom;if(!c.imageEl)return;if(!d.isTouched||!d.isMoved)return d.isTouched=!1,void(d.isMoved=!1);d.isTouched=!1,d.isMoved=!1;let i=300,a=300;const r=u.x*i,s=d.currentX+r,o=u.y*a,n=d.currentY+o;0!==u.x&&(i=Math.abs((s-d.currentX)/u.x)),0!==u.y&&(a=Math.abs((n-d.currentY)/u.y));const l=Math.max(i,a);d.currentX=s,d.currentY=n;const m=d.width*t.scale,p=d.height*t.scale;d.minX=Math.min(c.slideWidth/2-m/2,0),d.maxX=-d.minX,d.minY=Math.min(c.slideHeight/2-p/2,0),d.maxY=-d.minY,d.currentX=Math.max(Math.min(d.currentX,d.maxX),d.minX),d.currentY=Math.max(Math.min(d.currentY,d.maxY),d.minY),c.imageWrapEl.style.transitionDuration=`${l}ms`,c.imageWrapEl.style.transform=`translate3d(${d.currentX}px, ${d.currentY}px,0)`}()})),i("doubleTap",((t,i)=>{!e.animating&&e.params.zoom.enabled&&e.zoom.enabled&&e.params.zoom.toggle&&z(i)})),i("transitionEnd",(()=>{e.zoom.enabled&&e.params.zoom.enabled&&X()})),i("slideChange",(()=>{e.zoom.enabled&&e.params.zoom.enabled&&e.params.cssMode&&X()})),Object.assign(e.zoom,{enable:w,disable:M,in:Y,out:y,toggle:z})}
import{boolean}from"type-func";import{cancelAnimationFrame,requestAnimationFrame}from"animation-frame-polyfill";import{addElements,hasElement,removeElements}from"dom-set";import{createPointCB,getClientRect,pointInside}from"dom-plane";import mousemoveDispatcher from"dom-mousemove-dispatcher";function AutoScroller(e,n){void 0===n&&(n={});var t=this,o=4,i=!1;this.margin=n.margin||-1,this.scrollWhenOutside=n.scrollWhenOutside||!1;var r={},a=createPointCB(r),m=mousemoveDispatcher(),d=!1;window.addEventListener("mousemove",a,!1),window.addEventListener("touchmove",a,!1),isNaN(n.maxSpeed)||(o=n.maxSpeed),this.autoScroll=boolean(n.autoScroll),this.syncMove=boolean(n.syncMove,!1),this.destroy=function(n){window.removeEventListener("mousemove",a,!1),window.removeEventListener("touchmove",a,!1),window.removeEventListener("mousedown",w,!1),window.removeEventListener("touchstart",w,!1),window.removeEventListener("mouseup",p,!1),window.removeEventListener("touchend",p,!1),window.removeEventListener("pointerup",p,!1),window.removeEventListener("mouseleave",g,!1),window.removeEventListener("mousemove",L,!1),window.removeEventListener("touchmove",L,!1),window.removeEventListener("scroll",f,!0),e=[],n&&h()},this.add=function(){for(var n=[],t=arguments.length;t--;)n[t]=arguments[t];return addElements.apply(void 0,[e].concat(n)),this},this.remove=function(){for(var n=[],t=arguments.length;t--;)n[t]=arguments[t];return removeElements.apply(void 0,[e].concat(n))};var s,c,u=null;"[object Array]"!==Object.prototype.toString.call(e)&&(e=[e]),c=e,e=[],c.forEach((function(e){e===window?u=window:t.add(e)})),Object.defineProperties(this,{down:{get:function(){return d}},maxSpeed:{get:function(){return o}},point:{get:function(){return r}},scrolling:{get:function(){return i}}});var l,v=null;function f(n){for(var t=0;t<e.length;t++)if(e[t]===n.target){i=!0;break}i&&requestAnimationFrame((function(){return i=!1}))}function w(){d=!0}function p(){d=!1,h()}function h(){cancelAnimationFrame(l),cancelAnimationFrame(s)}function g(){d=!1}function E(){for(var n=null,t=0;t<e.length;t++)inside(r,e[t])&&(n=e[t]);return n}function L(n){if(t.autoScroll()&&!n.dispatched){var o=n.target,i=document.body;v&&!inside(r,v)&&(t.scrollWhenOutside||(v=null)),o&&o.parentNode===i?o=E():(o=function(n){if(!n)return null;if(v===n)return n;if(hasElement(e,n))return n;for(;n=n.parentNode;)if(hasElement(e,n))return n;return null}(o))||(o=E()),o&&o!==v&&(v=o),u&&(cancelAnimationFrame(s),s=requestAnimationFrame(y)),v&&(cancelAnimationFrame(l),l=requestAnimationFrame(A))}}function y(){x(u),cancelAnimationFrame(s),s=requestAnimationFrame(y)}function A(){v&&(x(v),cancelAnimationFrame(l),l=requestAnimationFrame(A))}function x(e){var n,o,i=getClientRect(e);n=r.x<i.left+t.margin?Math.floor(Math.max(-1,(r.x-i.left)/t.margin-1)*t.maxSpeed):r.x>i.right-t.margin?Math.ceil(Math.min(1,(r.x-i.right)/t.margin+1)*t.maxSpeed):0,o=r.y<i.top+t.margin?Math.floor(Math.max(-1,(r.y-i.top)/t.margin-1)*t.maxSpeed):r.y>i.bottom-t.margin?Math.ceil(Math.min(1,(r.y-i.bottom)/t.margin+1)*t.maxSpeed):0,t.syncMove()&&m.dispatch(e,{pageX:r.pageX+n,pageY:r.pageY+o,clientX:r.x+n,clientY:r.y+o}),setTimeout((function(){o&&function(e,n){e===window?window.scrollTo(e.pageXOffset,e.pageYOffset+n):e.scrollTop+=n}(e,o),n&&function(e,n){e===window?window.scrollTo(e.pageXOffset+n,e.pageYOffset):e.scrollLeft+=n}(e,n)}))}window.addEventListener("mousedown",w,!1),window.addEventListener("touchstart",w,!1),window.addEventListener("mouseup",p,!1),window.addEventListener("touchend",p,!1),window.addEventListener("pointerup",p,!1),window.addEventListener("mousemove",L,!1),window.addEventListener("touchmove",L,!1),window.addEventListener("mouseleave",g,!1),window.addEventListener("scroll",f,!0)}function AutoScrollerFactory(e,n){return new AutoScroller(e,n)}function inside(e,n,t){return t?e.y>t.top&&e.y<t.bottom&&e.x>t.left&&e.x<t.right:pointInside(e,n)}export default AutoScrollerFactory;
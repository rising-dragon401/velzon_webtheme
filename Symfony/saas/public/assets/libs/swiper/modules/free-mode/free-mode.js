import{elementTransitionEnd,now}from"../../shared/utils.js";export default function freeMode({swiper:e,extendParams:t,emit:o,once:n}){t({freeMode:{enabled:!1,momentum:!0,momentumRatio:1,momentumBounce:!0,momentumBounceRatio:1,momentumVelocityRatio:1,sticky:!1,minimumVelocity:.02}}),Object.assign(e,{freeMode:{onTouchStart:function(){const t=e.getTranslate();e.setTranslate(t),e.setTransition(0),e.touchEventsData.velocities.length=0,e.freeMode.onTouchEnd({currentPos:e.rtl?e.translate:-e.translate})},onTouchMove:function(){const{touchEventsData:t,touches:o}=e;0===t.velocities.length&&t.velocities.push({position:o[e.isHorizontal()?"startX":"startY"],time:t.touchStartTime}),t.velocities.push({position:o[e.isHorizontal()?"currentX":"currentY"],time:now()})},onTouchEnd:function({currentPos:t}){const{params:i,wrapperEl:s,rtlTranslate:a,snapGrid:l,touchEventsData:r}=e,m=now()-r.touchStartTime;if(t<-e.minTranslate())e.slideTo(e.activeIndex);else if(t>-e.maxTranslate())e.slides.length<l.length?e.slideTo(l.length-1):e.slideTo(e.slides.length-1);else{if(i.freeMode.momentum){if(r.velocities.length>1){const t=r.velocities.pop(),o=r.velocities.pop(),n=t.position-o.position,s=t.time-o.time;e.velocity=n/s,e.velocity/=2,Math.abs(e.velocity)<i.freeMode.minimumVelocity&&(e.velocity=0),(s>150||now()-t.time>300)&&(e.velocity=0)}else e.velocity=0;e.velocity*=i.freeMode.momentumVelocityRatio,r.velocities.length=0;let t=1e3*i.freeMode.momentumRatio;const m=e.velocity*t;let c=e.translate+m;a&&(c=-c);let d,u=!1;const f=20*Math.abs(e.velocity)*i.freeMode.momentumBounceRatio;let T;if(c<e.maxTranslate())i.freeMode.momentumBounce?(c+e.maxTranslate()<-f&&(c=e.maxTranslate()-f),d=e.maxTranslate(),u=!0,r.allowMomentumBounce=!0):c=e.maxTranslate(),i.loop&&i.centeredSlides&&(T=!0);else if(c>e.minTranslate())i.freeMode.momentumBounce?(c-e.minTranslate()>f&&(c=e.minTranslate()+f),d=e.minTranslate(),u=!0,r.allowMomentumBounce=!0):c=e.minTranslate(),i.loop&&i.centeredSlides&&(T=!0);else if(i.freeMode.sticky){let t;for(let e=0;e<l.length;e+=1)if(l[e]>-c){t=e;break}c=Math.abs(l[t]-c)<Math.abs(l[t-1]-c)||"next"===e.swipeDirection?l[t]:l[t-1],c=-c}if(T&&n("transitionEnd",(()=>{e.loopFix()})),0!==e.velocity){if(t=a?Math.abs((-c-e.translate)/e.velocity):Math.abs((c-e.translate)/e.velocity),i.freeMode.sticky){const o=Math.abs((a?-c:c)-e.translate),n=e.slidesSizesGrid[e.activeIndex];t=o<n?i.speed:o<2*n?1.5*i.speed:2.5*i.speed}}else if(i.freeMode.sticky)return void e.slideToClosest();i.freeMode.momentumBounce&&u?(e.updateProgress(d),e.setTransition(t),e.setTranslate(c),e.transitionStart(!0,e.swipeDirection),e.animating=!0,elementTransitionEnd(s,(()=>{e&&!e.destroyed&&r.allowMomentumBounce&&(o("momentumBounce"),e.setTransition(i.speed),setTimeout((()=>{e.setTranslate(d),elementTransitionEnd(s,(()=>{e&&!e.destroyed&&e.transitionEnd()}))}),0))}))):e.velocity?(o("_freeModeNoMomentumRelease"),e.updateProgress(c),e.setTransition(t),e.setTranslate(c),e.transitionStart(!0,e.swipeDirection),e.animating||(e.animating=!0,elementTransitionEnd(s,(()=>{e&&!e.destroyed&&e.transitionEnd()})))):e.updateProgress(c),e.updateActiveIndex(),e.updateSlidesClasses()}else{if(i.freeMode.sticky)return void e.slideToClosest();i.freeMode&&o("_freeModeNoMomentumRelease")}(!i.freeMode.momentum||m>=i.longSwipesMs)&&(e.updateProgress(),e.updateActiveIndex(),e.updateSlidesClasses())}}}})}